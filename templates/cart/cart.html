{% extends 'shop/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üõí –í–∞—à–∞—Ç–∞ –∫–æ–ª–∏—á–∫–∞</h2>

    {% if cart_items %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="thead-light">
                <tr>
                    <th style="width: 15%">–°–Ω–∏–º–∫–∞</th>
                    <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                    <th>–¶–≤—è—Ç</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–û–±—â–æ</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>
                        {% if item.variant.image_url %}
                            <img src="{{ item.variant.image_url }}"
                                 alt="{{ item.variant.product.name }}"
                                 class="img-fluid rounded"
                                 style="max-height: 80px;">
                        {% elif item.variant.product.main_image %}
                            <img src="{{ item.variant.product.main_image.url }}"
                                 alt="{{ item.variant.product.name }}"
                                 class="img-fluid rounded"
                                 style="max-height: 80px;">
                        {% else %}
                            <div class="no-image-placeholder rounded" style="width: 80px; height: 80px; background-color: #f8f9fa;"></div>
                        {% endif %}
                    </td>
                    <td>{{ item.variant.product.name }}</td>
                    <td>
                        <span class="color-badge"
                              style="background-color: {{ item.variant.color.hex_code }};
                                     width: 20px;
                                     height: 20px;
                                     display: inline-block;
                                     border-radius: 50%;
                                     border: 1px solid #ddd;"></span>
                        {{ item.variant.color.name }}
                    </td>
                    <td>{{ item.variant.get_final_price|floatformat:2 }} –ª–≤</td>
                    <td>
    <div class="quantity-control d-flex align-items-center">
        <form method="POST" action="{% url 'update_cart_item' item.id %}" class="d-inline" id="update-form-{{ item.id }}">
            {% csrf_token %}
            <div class="input-group">
                <input type="number"
                       name="quantity"
                       value="{{ item.quantity }}"
                       min="1"
                       max="10"
                       class="form-control form-control-sm"
                       style="width: 60px;"
                       id="quantity-input-{{ item.id }}">
                <div class="input-group-append">
                    <button type="submit" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</td>
                    <td>{{ item.get_total_price|floatformat:2 }} –ª–≤</td>
                    <td>
                        <a href="{% url 'remove_from_cart' item.id %}"
                           class="btn btn-outline-danger btn-sm"
                           title="–ü—Ä–µ–º–∞—Ö–Ω–∏">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="table-secondary">
                <tr>
                    <td colspan="5" class="text-right"><strong>–ö—Ä–∞–π–Ω–∞ —Å—É–º–∞:</strong></td>
                    <td><strong>{{ total_price|floatformat:2 }} –ª–≤</strong></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> –ü—Ä–æ–¥—ä–ª–∂–∏ –ø–∞–∑–∞—Ä—É–≤–∞–Ω–µ—Ç–æ
        </a>
        <a href="{% url 'proceed_to_payment' %}" class="btn btn-primary">
            –ü–ª–∞—â–∞–Ω–µ <i class="fas fa-arrow-right"></i>
        </a>
    </div>
    {% else %}
    <div class="alert alert-info">
        –í–∞—à–∞—Ç–∞ –∫–æ–ª–∏—á–∫–∞ –µ –ø—Ä–∞–∑–Ω–∞. <a href="{% url 'home' %}">–†–∞–∑–≥–ª–µ–¥–∞–π—Ç–µ –Ω–∞—à–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç–∏</a>.
    </div>
    {% endif %}
</div>

<style>
    .color-badge {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .quantity-control input::-webkit-outer-spin-button,
    .quantity-control input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .quantity-control input[type=number] {
        -moz-appearance: textfield;
    }

    .no-image-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
    }

     .input-group {
        width: auto;
    }

    .input-group-append .btn {
        padding: 0.25rem 0.5rem;
    }

    .input-group-sm .form-control {
        padding: 0.25rem 0.5rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–±—Ä–∞–Ω—è–≤–∞–º–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—Ç–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('change', function(e) {
            // –°–∞–º–æ –º–∞—Ä–∫–∏—Ä–∞–º–µ –∫–∞—Ç–æ –ø—Ä–æ–º–µ–Ω–µ–Ω–æ, –Ω–æ –Ω–µ –∏–∑–ø—Ä–∞—â–∞–º–µ —Ñ–æ—Ä–º–∞—Ç–∞
            this.dataset.changed = 'true';
        });
    });

    // –†—ä—á–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫ –Ω–∞ –±—É—Ç–æ–Ω–∞
    document.querySelectorAll('.input-group-append button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('form');
            form.submit();
        });
    });
});
</script>
{% endblock %}